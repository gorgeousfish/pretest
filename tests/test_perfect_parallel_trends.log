
  ___  ____  ____  ____  ____ ®
 /__    /   ____/   /   ____/      18.0
___/   /   /___/   /   /___/       MP—Parallel Edition

 Statistics and Data Science       Copyright 1985-2023 StataCorp LLC
                                   StataCorp
                                   4905 Lakeway Drive
                                   College Station, Texas 77845 USA
                                   800-STATA-PC        https://www.stata.com
                                   979-696-4600        stata@stata.com

Stata license: Single-user 2-core  perpetual
Serial number: 501806366048
  Licensed to: 蔡炫宇
               1

Notes:
      1. Stata is running in batch mode.
      2. Unicode is supported; see help unicode_advice.
      3. More than 2 billion observations are allowed; see help obs_advice.
      4. Maximum number of variables is set to 5,000 but can be increased;
          see help set_maxvar.


Running /Applications/Stata/profile.do ...

. do /Users/cxy/Desktop/2026project/pretest/pretest-stata/tests/test_perfect_pa
> rallel_trends.do 

. *! test_perfect_parallel_trends.do
. *! Test: Perfect Parallel Trends Scenario
. *! Purpose: Verify correct behavior when parallel trends hold perfectly
. *!
. *! Key insight from OPT-008 investigation:
. *!   When treatment effect is constant and parallel trends hold,
. *!   δ_t ≈ 0 is CORRECT behavior (not a bug)
. *!
. *! This test validates that:
. *!   1. δ_{t0} = 0 always (mathematical necessity)
. *!   2. δ_t ≈ 0 when treatment effect is constant
. *!   3. S_pre ≈ 0 when parallel trends hold perfectly
. *!   4. Pretest passes when S_pre < M
. 
. version 17.0

. clear all

. set more off

. set seed 20251220

. 
. // ============================================================
. // SETUP
. // ============================================================
. 
. local base_path "/Users/cxy/Desktop/2026project/pretest/pretest-stata"

. adopath + "`base_path'/ado"
  [1]  (BASE)      "/Applications/Stata/ado/base/"
  [2]  (SITE)      "/Applications/Stata/ado/site/"
  [3]              "."
  [4]  (PERSONAL)  "/Applications/Stata/personal/"
  [5]  (PLUS)      "/Applications/Stata/plus/"
  [6]  (OLDPLACE)  "~/ado/"
  [7]              "/Users/cxy/Desktop/2026project/pretest/pretest-stata/ado"

. do "`base_path'/_pretest_mata.do"

. *! _pretest_mata.do v0.1.0
. *! Mata Library Loader for pretest Package
. *!
. *! Description:
. *!   Loads all Mata functions required by the pretest command.
. *!   Automatically called by pretest.ado or can be run manually.
. *!
. *! Usage:
. *!   . do _pretest_mata.do
. *!
. *! Reference:
. *!   Mikhaeil, J.M. and C. Harshaw. 2025. In Defense of the Pre-Test.
. *!   arXiv:2510.26470. https://arxiv.org/abs/2510.26470
. 
. version 17.0

. 
. // Display loading status
. di as text "{hline 60}"
------------------------------------------------------------

. di as text "Loading pretest Mata library..."
Loading pretest Mata library...

. di as text "{hline 60}"
------------------------------------------------------------

. 
. // Clear any existing definitions to avoid conflicts
. capture noisily mata: mata drop _pretest_*()

. 
. // ============================================================
. // Load Mata source files (in dependency order)
. // Uses findfile for compatibility with Stata's installation structure
. // ============================================================
. 
. // Helper program: locate and execute Mata files
. // Searches: (1) mata/ subdirectory via c(filename), (2) findfile this script
> ,
. // (3) findfile the target file directly
. capture program drop _pretest_load_mata

. program define _pretest_load_mata
  1.     args filename
  2.     
.     // Method 1: Locate via current script directory (c(filename))
.     local thisfile "`c(filename)'"
  3.     if "`thisfile'" != "" {
  4.         local basedir = subinstr("`thisfile'", "_pretest_mata.do", "", .)
  5.         local matapath "`basedir'mata/`filename'"
  6.         capture confirm file "`matapath'"
  7.         if _rc == 0 {
  8.             quietly do "`matapath'"
  9.             di as text "  [OK] `filename' loaded from mata/"
 10.             exit
 11.         }
 12.     }
 13.     
.     // Method 2: Locate via findfile on this script
.     capture findfile _pretest_mata.do
 14.     if _rc == 0 {
 15.         local basedir = subinstr("`r(fn)'", "_pretest_mata.do", "", .)
 16.         local matapath "`basedir'mata/`filename'"
 17.         capture confirm file "`matapath'"
 18.         if _rc == 0 {
 19.             quietly do "`matapath'"
 20.             di as text "  [OK] `filename' loaded from mata/"
 21.             exit
 22.         }
 23.     }
 24.     
.     // Method 3: Direct findfile on target file
.     capture findfile `filename'
 25.     if _rc == 0 {
 26.         quietly do "`r(fn)'"
 27.         di as text "  [OK] `filename' loaded via findfile"
 28.         exit
 29.     }
 30.     
.     // Method 4: Search via findfile on pretest.ado then look in sibling mata
> /
.     capture findfile pretest.ado
 31.     if _rc == 0 {
 32.         local adomatch "`r(fn)'"
 33.         local basedir = subinstr("`adomatch'", "pretest.ado", "", .)
 34.         local matapath "`basedir'mata/`filename'"
 35.         capture confirm file "`matapath'"
 36.         if _rc == 0 {
 37.             quietly do "`matapath'"
 38.             di as text "  [OK] `filename' loaded via pretest.ado sibling"
 39.             exit
 40.         }
 41.     }
 42.     
.     // Method 5: Search via sysdir standard locations
.     foreach sdir in PLUS PERSONAL SITE {
 43.         local sysdir : sysdir `sdir'
 44.         if "`sysdir'" != "" {
 45.             // Try direct in sysdir/mata/
.             local matapath "`sysdir'mata/`filename'"
 46.             capture confirm file "`matapath'"
 47.             if _rc == 0 {
 48.                 quietly do "`matapath'"
 49.                 di as text "  [OK] `filename' loaded from `sdir'/mata/"
 50.                 exit
 51.             }
 52.         }
 53.     }
 54.     
.     di as error "  [X] `filename' not found"
 55.     di as error "      Searched: c(filename), findfile, pretest.ado siblin
> g, sysdir"
 56.     exit 601
 57. end

. 
. // 1. Utility functions (no dependencies)
. _pretest_load_mata _pretest_utils.mata
  [OK] _pretest_utils.mata loaded via findfile

. 
. // 2. DID estimator functions
. _pretest_load_mata _pretest_estimators.mata
  [OK] _pretest_estimators.mata loaded via findfile

. 
. // 3. Violation estimation functions
. _pretest_load_mata _pretest_violations.mata
  [OK] _pretest_violations.mata loaded via findfile

. 
. // 4. Covariance matrix estimation
. _pretest_load_mata _pretest_covariance.mata
  [OK] _pretest_covariance.mata loaded via findfile

. 
. // 5. Kappa constant computation
. _pretest_load_mata _pretest_kappa.mata
  [OK] _pretest_kappa.mata loaded via findfile

. 
. // 6. Psi function and Monte Carlo critical values
. _pretest_load_mata _pretest_psi.mata
  [OK] _pretest_psi.mata loaded via findfile

. 
. // 7. Confidence interval functions
. _pretest_load_mata _pretest_ci.mata
  [OK] _pretest_ci.mata loaded via findfile

. 
. // 8. Coverage simulation functions (optional)
. capture _pretest_load_mata _pretest_simulation.mata

. if _rc {
.     di as text "  [!] _pretest_simulation.mata not found (optional)"
. }

. 
. // 9. Main computation function
. _pretest_load_mata _pretest_main.mata
  [OK] _pretest_main.mata loaded via findfile

. 
. // Clean up helper program
. capture program drop _pretest_load_mata

. 
. // ============================================================
. // Complete
. // ============================================================
. 
. di as text "{hline 60}"
------------------------------------------------------------

. di as text "pretest Mata library loaded successfully"
pretest Mata library loaded successfully

. di as text "{hline 60}"
------------------------------------------------------------

. 
end of do-file

. 
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "Test: Perfect Parallel Trends Scenario"
Test: Perfect Parallel Trends Scenario

. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text ""


. 
. local n_passed = 0

. local n_failed = 0

. local n_tests = 0

. 
. // ============================================================
. // TEST 1: Constant Treatment Effect + Perfect Parallel Trends
. // ============================================================
. di as text "{hline 60}"
------------------------------------------------------------

. di as text "TEST 1: Constant Treatment Effect (τ=2) + Perfect PT"
TEST 1: Constant Treatment Effect (τ=2) + Perfect PT

. di as text "{hline 60}"
------------------------------------------------------------

. 
. local `++n_tests'

. 
. clear

. local n_units = 200

. local T = 5

. local t0 = 4

. local true_att = 2

. 
. set obs `=`n_units' * `T''
Number of observations (_N) was 0, now 1,000.

. gen unit_id = ceil(_n / `T')

. bysort unit_id: gen time = _n

. gen D = (unit_id <= `=`n_units'/2')

. 
. // Unit fixed effects
. gen alpha_i = rnormal(0, 0.3)

. bysort unit_id: replace alpha_i = alpha_i[1]
(800 real changes made)

. 
. // Small noise
. gen epsilon = rnormal(0, 0.05)

. 
. // Y = 1 + 0.5*time + 2*D*(time >= t0) + alpha_i + epsilon
. // NO parallel trends violation
. gen Y = 1 + 0.5 * time + `true_att' * D * (time >= `t0') + alpha_i + epsilon

. 
. xtset unit_id time

Panel variable: unit_id (strongly balanced)
 Time variable: time, 1 to 5
         Delta: 1 unit

. 
. // Run pretest
. capture pretest Y, treatment(D) time(time) threshold(1) p(1) treat_time(`t0')

. 
. if _rc == 0 {
.     local delta_bar = e(delta_bar)
.     local S_pre = e(S_pre)
.     local pretest_pass = e(pretest_pass)
.     
.     di as text ""

.     di as text "Results:"
Results:
.     di as text "  delta_bar    = " %12.6f `delta_bar'
  delta_bar    =     0.002555
.     di as text "  S_pre        = " %12.6f `S_pre'
  S_pre        =     0.003027
.     di as text "  pretest_pass = " `pretest_pass'
  pretest_pass = 1
.     
.     // Check 1: delta_bar should be close to 0 (within tolerance)
.     local tol = 0.1
.     if abs(`delta_bar') < `tol' {
.         di as result "  [PASS] delta_bar ≈ 0 (expected for constant τ)"
  [PASS] delta_bar ≈ 0 (expected for constant τ)
.         local `++n_passed'
.     }
.     else {
.         di as error "  [FAIL] delta_bar = " %9.4f `delta_bar' ", expected ≈ 0
> "
.         local `++n_failed'
.     }
.     
.     // Check 2: S_pre should be small
.     if `S_pre' < 0.1 {
.         di as result "  [PASS] S_pre ≈ 0 (perfect parallel trends)"
  [PASS] S_pre ≈ 0 (perfect parallel trends)
.     }
.     else {
.         di as text "  [INFO] S_pre = " %9.4f `S_pre' " (sampling variation)"
.     }
.     
.     // Check 3: Pretest should pass
.     if `pretest_pass' == 1 {
.         di as result "  [PASS] Pretest passed"
  [PASS] Pretest passed
.     }
.     else {
.         di as error "  [FAIL] Pretest failed unexpectedly"
.     }
. }

. else {
.     di as error "  [FAIL] pretest command error: `=_rc'"
.     local `++n_failed'
. }

. 
. 
. // ============================================================
. // TEST 2: Growing Treatment Effect
. // ============================================================
. di as text ""


. di as text "{hline 60}"
------------------------------------------------------------

. di as text "TEST 2: Growing Treatment Effect (τ_4=2, τ_5=4)"
TEST 2: Growing Treatment Effect (τ_4=2, τ_5=4)

. di as text "{hline 60}"
------------------------------------------------------------

. 
. local `++n_tests'

. 
. clear

. set obs `=`n_units' * `T''
Number of observations (_N) was 0, now 1,000.

. gen unit_id = ceil(_n / `T')

. bysort unit_id: gen time = _n

. gen D = (unit_id <= `=`n_units'/2')

. 
. gen alpha_i = rnormal(0, 0.3)

. bysort unit_id: replace alpha_i = alpha_i[1]
(800 real changes made)

. gen epsilon = rnormal(0, 0.05)

. 
. // Growing treatment effect: τ_4 = 2, τ_5 = 4
. gen tau_t = 0

. replace tau_t = 2 if D == 1 & time == 4
(100 real changes made)

. replace tau_t = 4 if D == 1 & time == 5
(100 real changes made)

. 
. gen Y = 1 + 0.5 * time + tau_t + alpha_i + epsilon

. 
. xtset unit_id time

Panel variable: unit_id (strongly balanced)
 Time variable: time, 1 to 5
         Delta: 1 unit

. 
. capture pretest Y, treatment(D) time(time) threshold(2) p(1) treat_time(`t0')

. 
. if _rc == 0 {
.     local delta_bar = e(delta_bar)
.     
.     di as text ""

.     di as text "Results:"
Results:
.     di as text "  delta_bar = " %12.6f `delta_bar'
  delta_bar =     0.998410
.     
.     // δ_4 = 0 (by definition)
.     // δ_5 = τ_5 - τ_4 = 4 - 2 = 2
.     // δ̄ = (0 + 2) / 2 = 1
.     local expected = 1
.     local tol = 0.15
.     
.     if abs(`delta_bar' - `expected') < `tol' {
.         di as result "  [PASS] delta_bar ≈ " `expected' " (expected for growi
> ng τ)"
  [PASS] delta_bar ≈ 1 (expected for growing τ)
.         local `++n_passed'
.     }
.     else {
.         di as error "  [FAIL] delta_bar = " %9.4f `delta_bar' ", expected ≈ "
>  `expected'
.         local `++n_failed'
.     }
. }

. else {
.     di as error "  [FAIL] pretest command error: `=_rc'"
.     local `++n_failed'
. }

. 
. 
. // ============================================================
. // TEST 3: Verify δ_{t0} = 0 Always
. // ============================================================
. di as text ""


. di as text "{hline 60}"
------------------------------------------------------------

. di as text "TEST 3: Verify δ_{t0} = 0 (mathematical necessity)"
TEST 3: Verify δ_{t0} = 0 (mathematical necessity)

. di as text "{hline 60}"
------------------------------------------------------------

. 
. local `++n_tests'

. 
. // Use data from TEST 2
. capture pretest Y, treatment(D) time(time) threshold(2) p(1) treat_time(`t0')
>  diagnose

. 
. if _rc == 0 {
.     matrix delta_vec = e(delta)
.     local delta_t0 = delta_vec[1,1]
.     
.     di as text "  δ_{t0} = " %12.8f `delta_t0'
  δ_{t0} =   0.00000000
.     
.     // δ_{t0} should be exactly 0 (or very close due to floating point)
.     if abs(`delta_t0') < 1e-10 {
.         di as result "  [PASS] δ_{t0} = 0 (exact)"
  [PASS] δ_{t0} = 0 (exact)
.         local `++n_passed'
.     }
.     else {
.         di as error "  [FAIL] δ_{t0} = " %12.8f `delta_t0' ", expected = 0"
.         local `++n_failed'
.     }
. }

. else {
.     di as error "  [FAIL] pretest command error: `=_rc'"
.     local `++n_failed'
. }

. 
. 
. // ============================================================
. // TEST 4: Small Parallel Trends Violation
. // ============================================================
. di as text ""


. di as text "{hline 60}"
------------------------------------------------------------

. di as text "TEST 4: Small Parallel Trends Violation"
TEST 4: Small Parallel Trends Violation

. di as text "{hline 60}"
------------------------------------------------------------

. 
. local `++n_tests'

. 
. clear

. set obs `=`n_units' * `T''
Number of observations (_N) was 0, now 1,000.

. gen unit_id = ceil(_n / `T')

. bysort unit_id: gen time = _n

. gen D = (unit_id <= `=`n_units'/2')

. 
. gen alpha_i = rnormal(0, 0.3)

. bysort unit_id: replace alpha_i = alpha_i[1]
(800 real changes made)

. gen epsilon = rnormal(0, 0.05)

. 
. // Small PT violation: treated group has extra 0.05*time trend
. gen pt_violation = 0.05 * time * D

. 
. gen Y = 1 + 0.5 * time + pt_violation + 2 * D * (time >= `t0') + alpha_i + ep
> silon

. 
. xtset unit_id time

Panel variable: unit_id (strongly balanced)
 Time variable: time, 1 to 5
         Delta: 1 unit

. 
. capture pretest Y, treatment(D) time(time) threshold(1) p(1) treat_time(`t0')

. 
. if _rc == 0 {
.     local S_pre = e(S_pre)
.     local pretest_pass = e(pretest_pass)
.     
.     di as text ""

.     di as text "Results:"
Results:
.     di as text "  S_pre        = " %12.6f `S_pre'
  S_pre        =     0.046922
.     di as text "  pretest_pass = " `pretest_pass'
  pretest_pass = 1
.     
.     // S_pre should be small but positive (around 0.05)
.     if `S_pre' > 0 & `S_pre' < 0.2 {
.         di as result "  [PASS] S_pre > 0 detected small violation"
  [PASS] S_pre > 0 detected small violation
.         local `++n_passed'
.     }
.     else {
.         di as error "  [FAIL] S_pre = " %9.4f `S_pre' ", expected small posit
> ive value"
.         local `++n_failed'
.     }
. }

. else {
.     di as error "  [FAIL] pretest command error: `=_rc'"
.     local `++n_failed'
. }

. 
. 
. // ============================================================
. // SUMMARY
. // ============================================================
. di as text ""


. di as text "{hline 70}"
----------------------------------------------------------------------

. di as text "TEST SUMMARY"
TEST SUMMARY

. di as text "{hline 70}"
----------------------------------------------------------------------

. 
. di as text "Tests run:    " `n_tests'
Tests run:    4

. di as text "Tests passed: " `n_passed'
Tests passed: 4

. di as text "Tests failed: " `n_failed'
Tests failed: 0

. 
. if `n_failed' == 0 {
.     di as result ""

.     di as result "{hline 70}"
----------------------------------------------------------------------
.     di as result " ALL TESTS PASSED"
 ALL TESTS PASSED
.     di as result "{hline 70}"
----------------------------------------------------------------------
. }

. else {
.     di as error ""
.     di as error "{hline 70}"
.     di as error " SOME TESTS FAILED"
.     di as error "{hline 70}"
.     error 9
. }

. 
. di as text ""


. di as text "Key Findings Verified:"
Key Findings Verified:

. di as text "  1. δ_{t0} = 0 always (by mathematical definition)"
  1. δ_{t0} = 0 always (by mathematical definition)

. di as text "  2. δ_t ≈ 0 when treatment effect is constant (correct behavior)
> "
  2. δ_t ≈ 0 when treatment effect is constant (correct behavior)

. di as text "  3. δ̄ captures treatment effect CHANGES, not levels"
  3. δ̄ captures treatment effect CHANGES, not levels

. di as text "  4. S_pre detects parallel trends violations correctly"
  4. S_pre detects parallel trends violations correctly

. 
. 
end of do-file
